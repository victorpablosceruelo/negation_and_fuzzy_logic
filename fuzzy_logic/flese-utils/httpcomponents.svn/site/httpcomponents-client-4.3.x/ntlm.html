<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at 2014-02-03 ( $Revision: 1563984 $ ) -->
<!-- $HeadURL: https://svn.apache.org/repos/asf/httpcomponents/maven-skin/trunk/src/main/resources/META-INF/maven/site.vm $ -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Apache HttpComponents - NTLM support in HttpClient</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20140203" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                        <a href="http://www.apache.org/" id="bannerLeft">
                                        <img src="http://www.apache.org/images/asf_logo_wide.gif" alt="Apache" />
                </a>
                                            <a href=".././" id="bannerRight">
                                                <img src="../images/logos/httpcomponents.png" alt="HttpComponents" />
                </a>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                
                <div class="xleft">
        <span id="publishDate">Last Published: 2014-02-03</span>
                  &nbsp;| <span id="projectVersion">Version: 1-SNAPSHOT</span>
                      </div>
            <div class="xright">                    <a href="http://www.apache.org/" class="externalLink" title="Apache">Apache</a>
            |
                        <a href="../index.html" title="HttpComponents">HttpComponents</a>
              
                
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                
                                <h5>HttpComponents</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/licenses/" class="externalLink" title="License">License</a>
            </li>
                  <li class="none">
                          <a href="../downloads.cgi" title="Download">Download</a>
            </li>
                  <li class="none">
                          <a href="../mail.html" title="Mailing Lists">Mailing Lists</a>
            </li>
                  <li class="none">
                          <a href="../dev-docs.html" title="Developer documents">Developer documents</a>
            </li>
                  <li class="none">
                          <a href="http://wiki.apache.org/HttpComponents/" class="externalLink" title="Wiki (external)">Wiki (external)</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/security/" class="externalLink" title="Security">Security</a>
            </li>
          </ul>
                       <h5>Overview</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="About">About</a>
            </li>
                  <li class="none">
                          <a href="../news.html" title="News">News</a>
            </li>
                  <li class="none">
                          <a href="../poweredby.html" title="Powered by">Powered by</a>
            </li>
                  <li class="none">
                          <a href="../get-involved.html" title="Get Involved">Get Involved</a>
            </li>
          </ul>
                       <h5>Components</h5>
                  <ul>
                                                                                                                                                                                                                              <li class="expanded">
                          <a href="../httpcomponents-client-4.3.x/index.html" title="HttpClient 4.3">HttpClient 4.3</a>
                    <ul>
                      <li class="none">
                          <a href="../httpcomponents-client-4.3.x/quickstart.html" title="Quick Start">Quick Start</a>
            </li>
                      <li class="none">
                          <a href="../httpcomponents-client-4.3.x/tutorial/html/index.html" title="Tutorial">Tutorial</a>
            </li>
                      <li class="none">
                          <a href="../httpcomponents-client-4.3.x/examples.html" title="Examples">Examples</a>
            </li>
                      <li class="none">
                          <a href="../httpcomponents-client-4.3.x/android-port.html" title="Android Port">Android Port</a>
            </li>
                      <li class="none">
                          <a href="../httpcomponents-client-4.3.x/primer.html" title="Programming Primer">Programming Primer</a>
            </li>
                      <li class="none">
            <strong>NTLM Guide</strong>
          </li>
                      <li class="none">
                          <a href="../httpcomponents-client-4.3.x/logging.html" title="Logging Guide">Logging Guide</a>
            </li>
                      <li class="none">
                          <a href="../httpcomponents-client-4.3.x/download.html" title="Download">Download</a>
            </li>
                      <li class="none">
                          <a href="../httpcomponents-client-4.3.x/project-info.html" title="Project Info">Project Info</a>
            </li>
              </ul>
        </li>
                                                                                                                                                                                                  <li class="collapsed">
                          <a href="../httpcomponents-client-4.2.x/index.html" title="HttpClient 4.2">HttpClient 4.2</a>
                  </li>
                                                                                                                          <li class="collapsed">
                          <a href="../httpcomponents-core-4.3.x/index.html" title="HttpCore 4.3">HttpCore 4.3</a>
                  </li>
                                                                                                                          <li class="collapsed">
                          <a href="../httpcomponents-core-4.2.x/index.html" title="HttpCore 4.2">HttpCore 4.2</a>
                  </li>
                                                                                                                          <li class="collapsed">
                          <a href="../httpcomponents-asyncclient-4.0.x/index.html" title="HttpAsyncClient 4.0">HttpAsyncClient 4.0</a>
                  </li>
          </ul>
                       <h5>Legacy</h5>
                  <ul>
                  <li class="none">
                          <a href="../httpclient-legacy/index.html" title="Commons HttpClient">Commons HttpClient</a>
            </li>
          </ul>
                       <h5>Project</h5>
                  <ul>
                  <li class="none">
                          <a href="../status.html" title="Status">Status</a>
            </li>
                  <li class="none">
                          <a href="../charter.html" title="Charter">Charter</a>
            </li>
          </ul>
                                 <h5>ASF</h5>
                  <ul>
                  <li class="none">
                          <a href="http://www.apache.org" class="externalLink" title="ASF Home Page">ASF Home Page</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/" class="externalLink" title="Foundation">Foundation</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsor Apache">Sponsor Apache</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                          <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
          </ul>
                       <h5>ASF</h5>
                  <ul>
                  <li class="none">
                          <a href="http://www.apache.org" class="externalLink" title="ASF Home Page">ASF Home Page</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/" class="externalLink" title="Foundation">Foundation</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsor Apache">Sponsor Apache</a>
            </li>
                  <li class="none">
                          <a href="http://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a>
            </li>
          </ul>
                                                                                                                   <a href="http://www.apache.org/events/current-event.html" title="ApacheCon" class="poweredBy">
        <img class="poweredBy"  alt="ApacheCon" src="http://www.apache.org/events/current-event-125x125.png"    />
      </a>
                                                                                                    <a href="http://maven.apache.org/" title="Maven" class="poweredBy">
        <img class="poweredBy"  alt="Maven" src="http://maven.apache.org/images/logos/maven-feather.png"    />
      </a>
                       
                
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!-- ==================================================================== --><!-- Licensed to the Apache Software Foundation (ASF) under one --><!-- or more contributor license agreements.  See the NOTICE file --><!-- distributed with this work for additional information --><!-- regarding copyright ownership.  The ASF licenses this file --><!-- to you under the Apache License, Version 2.0 (the --><!-- "License"); you may not use this file except in compliance --><!-- with the License.  You may obtain a copy of the License at --><!--  --><!-- http://www.apache.org/licenses/LICENSE-2.0 --><!--  --><!-- Unless required by applicable law or agreed to in writing, --><!-- software distributed under the License is distributed on an --><!-- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY --><!-- KIND, either express or implied.  See the License for the --><!-- specific language governing permissions and limitations --><!-- under the License. --><!-- ==================================================================== --><!--  --><!-- This software consists of voluntary contributions made by many --><!-- individuals on behalf of the Apache Software Foundation.  For more --><!-- information on the Apache Software Foundation, please see --><!-- <http://www.apache.org/>. --><div class="section">
<h2>NTLM support in HttpClient<a name="NTLM_support_in_HttpClient"></a></h2>
<div class="section">
<h3><a name="Background">Background</a></h3>
<p>NTLM is a proprietary authentication scheme developed by Microsoft and optimized for Windows operating system.</p>
<p>Until year 2008 there was no official, publicly available, complete documentation of the protocol. <a class="externalLink" href="http://davenport.sourceforge.net/ntlm.html">Unofficial</a> 3rd party protocol descriptions existed as a result of reverse-engineering efforts. It was not really known whether the protocol based on the reverse-engineering were complete or even correct.</p>
<p>Microsoft published <a class="externalLink" href="http://download.microsoft.com/download/a/e/6/ae6e4142-aa58-45c6-8dcf-a657e5900cd3/%5BMS-NLMP%5D.pdf">MS-NLMP</a> and <a class="externalLink" href="http://download.microsoft.com/download/a/e/6/ae6e4142-aa58-45c6-8dcf-a657e5900cd3/%5BMS-NTHT%5D.pdf">MS-NTHT</a> specifications in February 2008 as a part of its <a class="externalLink" href="http://www.microsoft.com/interop/principles/default.mspx">Interoperability Principles initiative</a>. </p>
<p>HttpClient as of version 4.1 initially supported NTLMv1, NTLMv2, and NTLM2SessionResponse authentication protocols, based on the reverse engineering approach. As of version 4.2.3, HttpClient now supports a more correct implementation, based in large part on Microsoft's own specifications. This is expected to correct a number of problems, especially since Microsoft (as of Windows Server 2008 R2) began using a new implementation of its protocols. This new Microsoft implementation has led to authentication failures in some cases from some of the older reverse-engineered client implementations of NTLM.</p>
<p>The new HttpClient NTLM implementation is known to have been tried successfully against at least the following systems:</p>
<ul>
<li>Windows Server 2000 and Server 2003 systems, configured to use LM and NTLMv1 authentication</li>
<li>Windows Server 2003 systems, configured to use NTLMv2 authentication</li>
<li>Windows Server 2008 R2 systems, configured to use NTLM2SessionResponse authentication</li></ul>
<p>If the current HttpClient NTLM implementation should prove problematic in your environment, we'd definitely like to hear about it. You are also welcome to try an alternative NTLM implementation, should it seem necessary. One can also use <a class="externalLink" href="http://jcifs.samba.org/">JCIFS</a>, which includes an NTLM engine developed by members of the Samba project. </p></div>
<div class="section">
<h3><a name="Using_Samba_JCIFS_as_an_alternative_NTLM_engine">Using Samba JCIFS as an alternative NTLM engine</a></h3>
<p>Follow these instructions to build an NTLMEngine implementation using JCIFS library</p>
<p><b>Disclaimer: Use code at your own discretion. Do NOT report any issues related to the use of JCIFS library to Apache HttpComponents project</b>.</p>
<ul>
<li>Download version 1.3.14 or newer of the JCIFS library from the <a class="externalLink" href="http://jcifs.samba.org/">Samba</a> web site</li>
<li>Implement NTLMEngine interface
<div>
<pre>import java.io.IOException;

import jcifs.ntlmssp.NtlmFlags;
import jcifs.ntlmssp.Type1Message;
import jcifs.ntlmssp.Type2Message;
import jcifs.ntlmssp.Type3Message;
import jcifs.util.Base64;

import org.apache.http.impl.auth.NTLMEngine;
import org.apache.http.impl.auth.NTLMEngineException;

public final class JCIFSEngine implements NTLMEngine {

    private static final int TYPE_1_FLAGS = 
            NtlmFlags.NTLMSSP_NEGOTIATE_56 | 
            NtlmFlags.NTLMSSP_NEGOTIATE_128 | 
            NtlmFlags.NTLMSSP_NEGOTIATE_NTLM2 | 
            NtlmFlags.NTLMSSP_NEGOTIATE_ALWAYS_SIGN | 
            NtlmFlags.NTLMSSP_REQUEST_TARGET;

    public String generateType1Msg(final String domain, final String workstation)
            throws NTLMEngineException {
        final Type1Message type1Message = new Type1Message(TYPE_1_FLAGS, domain, workstation);
        return Base64.encode(type1Message.toByteArray());
    }

    public String generateType3Msg(final String username, final String password,
            final String domain, final String workstation, final String challenge)
            throws NTLMEngineException {
        Type2Message type2Message;
        try {
            type2Message = new Type2Message(Base64.decode(challenge));
        } catch (final IOException exception) {
            throw new NTLMEngineException(&quot;Invalid NTLM type 2 message&quot;, exception);
        }
        final int type2Flags = type2Message.getFlags();
        final int type3Flags = type2Flags
                &amp; (0xffffffff ^ (NtlmFlags.NTLMSSP_TARGET_TYPE_DOMAIN | NtlmFlags.NTLMSSP_TARGET_TYPE_SERVER));
        final Type3Message type3Message = new Type3Message(type2Message, password, domain,
                username, workstation, type3Flags);
        return Base64.encode(type3Message.toByteArray());
    }

}</pre></div></li>
<li>Implement AuthSchemeProvider interface
<div>
<pre>public class JCIFSNTLMSchemeFactory implements AuthSchemeProvider {

    public AuthScheme create(final HttpContext context) {
        return new NTLMScheme(new JCIFSEngine());
    }
}</pre></div></li>
<li>Register NTLMSchemeFactory with the HttpClient instance you want to NTLM enable.
<div>
<pre>Registry&lt;AuthSchemeProvider&gt; authSchemeRegistry = RegistryBuilder.&lt;AuthSchemeProvider&gt;create()
        .register(AuthSchemes.NTLM, new JCIFSNTLMSchemeFactory())
        .register(AuthSchemes.BASIC, new BasicSchemeFactory())
        .register(AuthSchemes.DIGEST, new DigestSchemeFactory())
        .register(AuthSchemes.SPNEGO, new SPNegoSchemeFactory())
        .register(AuthSchemes.KERBEROS, new KerberosSchemeFactory())
        .build();
CloseableHttpClient httpClient = HttpClients.custom()
        .setDefaultAuthSchemeRegistry(authSchemeRegistry)
        .build();</pre></div></li>
<li>Set NTCredentials for the web server you are going to access.</li></ul></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
                      
<div class="xleft">Apache HttpComponents, Commons HttpClient, Apache, the Apache feather logo, and the Apache HttpComponents project logo are trademarks of The Apache Software Foundation.</div>
            
<br/>
            
<div class="xleft">All other marks mentioned may be trademarks or registered trademarks of their respective owners.</div>
                <div class="xright">Copyright &#169;                    2005-2014
                        <a href="http://www.apache.org/">The Apache Software Foundation</a>.
            All Rights Reserved.      
                
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
