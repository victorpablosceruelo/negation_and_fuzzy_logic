# -*- mode: Makefile; -*-
# ----------------------------------------------------------------------------
# Settings which are common to makefiles below
# but which you should not need to change
#-----------------------------------------------------------------------------
# *** This is here so that it can be seen by dist and doc
TARDOCFORMATS=ps pdf manl info infoindex html htmlindex
# Define this to be the main file name (with suffix if there is one).
MAIN:=ciao
CIAOSRC:=$(CIAODESRC)/$(MAIN)
SRC:=$(CIAOSRC)
ACTUALDIR:=$(notdir $(CIAOSRC))
BASEMAIN:=$(basename $(notdir $(MAIN)))
VERSIONFILE:=version/GlobalVersion
VERSION:=$(shell cat $(CIAOSRC)/$(VERSIONFILE))
PATCHFILE:=version/GlobalPatch
PATCH:=$(shell cat $(CIAOSRC)/$(PATCHFILE))
VERSIONMAIN:=$(BASEMAIN)-$(VERSION)
VPMAIN:=$(VERSIONMAIN)p$(PATCH)
WIN32VPMAIN:=$(VERSIONMAIN)p$(PATCH)Win32
SRCLIB:=$(CIAOSRC)
BOOTSTRAPDIR:=$(CIAOSRC)/bootstrap
SRCPREFIXDIR:=$(CIAODESRC)/build
SRCBINDIR:=$(SRCPREFIXDIR)/bin

BUILDBINDIR:=$(ROOTPREFIX)$(BINDIR)
BUILDLIBDIR:=$(ROOTPREFIX)$(LIBDIR)
BUILDREALLIBDIR:=$(ROOTPREFIX)$(REALLIBDIR)
BUILDXEMACSINITDIR:=$(ROOTPREFIX)$(XEMACSINITDIR)
BUILDCIAOMODEINITDIR:=$(ROOTPREFIX)$(CIAOMODEINITDIR)
#CIAOROOT not used any longer
#CIAOROOT=$(SRCLIB)
# note: if instype=ins, this is equal to INSTALLEDINCLUDEDIR
CIAOHDIR=$(CIAOHDIRROOT)/$(CIAOARCH)$(CIAODEBUG)
INSTALLEDINCLUDEDIR=$(REALLIBDIR)/include/$(CIAOARCH)$(CIAODEBUG)
STATOBJ=$(shell find $(CIAOSRC) -name "*$(CIAOARCH).o" -o -name "*$(CIAOARCH)_glue.o")
# random.o sockets_c.o fastrw.o
REMOTEMACHINES:=torquemada mayor clip

ifeq (CYGWIN,$(findstring CYGWIN,$(shell uname)))
 ALT:=win32
 EXECSUFFIX:=.exe
endif

ifeq ($(OSTYPE),cygwin)
  ALT:=win32
  EXECSUFFIX:=.exe
endif

ifeq ($(OSTYPE),cygwin32)
  ALT:=win32
  EXECSUFFIX:=.exe
endif

# The next is a kludge to use the .cpx extension in Windows

ifeq ($(ALT),win32)
  CIAOSUFFIX:=.cpx
endif

DISTSTATICCOMP:=ciaoc.sta
STATICCOMPNAME:=ciaoc-$(VERSION)$(CIAOSUFFIX)
CIAOSHELLNAME:=ciaosh
CIAOC:=$(SRCBINDIR)/$(STATICCOMPNAME)
BOOTSTRAP_CIAOC:=$(BOOTSTRAPDIR)/$(DISTSTATICCOMP)
CIAOSHELL:=$(SRCBINDIR)/$(CIAOSHELLNAME) -f

RTCHECK[yes]=-rc

RTCHECKS_TRUST[no]=--rtchecks-trust-no
RTCHECKS_ENTRY[no]=--rtchecks-entry-no
RTCHECKS_EXIT[no]=--rtchecks-exit-no
RTCHECKS_TEST[yes]=--rtchecks-test
RTCHECKS_LEVEL[exports]=--rtchecks-level-exports
RTCHECKS_INLINE[yes]=--rtchecks-inline
RTCHECKS_ASRLOC[no]=--rtchecks-asrloc-no
RTCHECKS_PREDLOC[no]=--rtchecks-predloc-no
RTCHECKS_NAMEFMT[short]=--rtchecks-namefmt-short
RTCHECKS_CALLLOC[no]=--rtchecks-callloc-no
RTCHECKS_CALLLOC[literal]=--rtchecks-callloc-literal
UNUSED_PRED_WARNINGS[yes]=--unused-pred-warnings

CIAOCOPTS_NORTCHECKS=$(UNUSED_PRED_WARNINGS[$(UNUSED_PRED_WARNINGS)])

CIAOCOPTS?=$(RTCHECK[$(RUNTIME_CHECKS)]) \
	$(RTCHECKS_TRUST[$(RTCHECKS_TRUST)]) \
	$(RTCHECKS_ENTRY[$(RTCHECKS_ENTRY)]) \
	$(RTCHECKS_EXIT[$(RTCHECKS_EXIT)]) \
	$(RTCHECKS_TEST[$(RTCHECKS_TEST)]) \
	$(RTCHECKS_LEVEL[$(RTCHECKS_LEVEL)]) \
	$(RTCHECKS_INLINE[$(RTCHECKS_INLINE)]) \
	$(RTCHECKS_ASRLOC[$(RTCHECKS_ASRLOC)]) \
	$(RTCHECKS_PREDLOC[$(RTCHECKS_PREDLOC)]) \
	$(RTCHECKS_NAMEFMT[$(RTCHECKS_NAMEFMT)]) \
	$(RTCHECKS_CALLLOC[$(RTCHECKS_CALLLOC)]) \
	$(RTCHECKS_CALLLOC[$(RTCHECKS_CALLLOC)]) \
	$(CIAOCOPTS_NORTCHECKS)

include $(CIAOSRC)/makefile-sysindep

include $(SYSDEP_FILES)/mkf-$(CIAOARCH)

OBJDIRROOT:=$(SRCPREFIXDIR)/objs
OBJDIRBASE:=$(OBJDIRROOT)/$(CIAOARCH)
OBJDIR:=$(OBJDIRBASE)$(CIAODEBUG)

# Relative path from $(OBJDIR) to the $(CIAOSRC)/engine directory
ENG_FROM_OBJDIR:=../../../ciao/engine

SRCINCLUDEDIRROOT:=$(SRCPREFIXDIR)/include
SRCINCLUDEDIR:=$(SRCINCLUDEDIRROOT)/$(CIAOARCH)$(CIAODEBUG)

CIAOLIBBASE:=lib$(MAIN)

# Name of the standard ciao library
CIAOLIBNAME:=$(CIAOLIBBASE)$(SOSUFFIX)

FIX_SIZE_EXEC:=$(OBJDIR)/fix_size$(EXECSUFFIX)

ENGINEBASE:=ciaoengine
ENGINENAME:=$(ENGINEBASE)$(EXECSUFFIX)
ENGINEBASESTAT:=$(ENGINEBASE).sta
ENGINENAMESTAT:=$(ENGINEBASESTAT)$(EXECSUFFIX)

INSTALLEDENGINE:=$(ENGINEDIR)/$(ENGINEBASE)

INSTALLEDENGINEARCH:=$(INSTALLEDENGINE).$(CIAOARCH)$(EXECSUFFIX)
INSTALLEDENGINESTAT:=$(INSTALLEDENGINE).sta$(EXECSUFFIX)
INSTALLEDENGINEARCHSTAT:=$(INSTALLEDENGINE).$(CIAOARCH).sta$(EXECSUFFIX)

SETLOCALCIAO:=CIAOALIASPATH="" CIAOLIB=$(SRCLIB) CIAOHDIR=$(SRCINCLUDEDIR) CIAOENGINE=$(OBJDIR)/$(ENGINENAME)

LPMAKE:=$(SRCBINDIR)/lpmake.sta
LPMAKEDEFOPTS:=
LPMAKECMD:=     $(SETLOCALCIAO) $(LPMAKE) $(LPMAKEDEFOPTS) $(LPMAKEOPTS)
LPMAKEINSTALL:= $(SETLOCALCIAO) $(LPMAKE) $(LPMAKEINSTALLOPTS)

# also defined in prolog
INSTALL_LOG:=$(CIAODESRC)/install.log

ENGINE_COMPILATION_FLAGS=$(CIAOSRC)/library/engine_compilation_flags_auto.pl

#-----------------------------------------------------------------------------
# Control Version System 

# Kludge: svnversion is checked only over installer to improve performance

ifeq ($(HAVE_SVNVERSION),yes)
SVNVERSION:=svnversion
REVISIONBASE0:=$(shell $(SVNVERSION) $(CIAODESRC)/makedir 2>/dev/null )
endif

ifeq ($(REVISIONBASE0),)
  REVISIONBASE:=exported
else
  REVISIONBASE:=$(REVISIONBASE0)
endif

ifeq ($(REVISIONBASE),exported)
  REVISION:=$(shell \
	if [ -f $(CIAODESRC)/REVISION ]; then \
		( cat $(CIAODESRC)/REVISION) ; \
	else \
		echo "0" ; \
	fi)
else
  REVISION=$(REVISIONBASE)
endif

#-----------------------------------------------------------------------------
