# -*- mode: Makefile; -*-

include $(SRCDIR)/SHARED-bench

BENCHPINS=$(addsuffix .pin, $(BENCHSRC))
BENCHOINS=$(addsuffix .oin, $(BENCHSRC))

.PHONY: benchcommon

.SUFFIXES: .pin .pl _$(CALIB2_NPROF)_prof_c.pl _$(CALIB2_NTIME)_time_c.pl _0_prof_c.pl _0_time_c.pl

VPATH+=:$(COMMONDIR):$(TESTSRCDIR):$(TESTSRCDIR)/calibs

benchcommon:: config.pl $(addsuffix _c.pl, $(CALIBRATORS2_ALL)) $(BENCHPINS) $(BENCHOINS)

COMMONPL=config.pl calibcommon.pl calibs0.pl c_common.pl

# This file transfer some configuration parameters to prolog:
config.pl: $(SRCDIR)/SHARED
	@echo "profile_examples($(PROFILE_EXAMPLES))." > $@
	@echo "repetitions( prof, $(CALIB2_NPROF), 1 )."               >> $@
	@echo "repetitions( time, $(CALIB2_NTIME), $(CALIB2_NREPS) )." >> $@
	@echo "repetitions( true, $(CALIB2_NTRUE), $(CALIB2_NREPS) )." >> $@

# Bug: broken dependecy between %_c.pl and calibrator generator
# %_c.pl: config.pl calibcommon.pl calibs0.pl
# 	( echo "consult(config)."   ; echo "consult(calibcommon)."; \
# 	  echo "consult(c_common)." ; echo "load_gen_c('$*')."; \
# 	  echo "consult(calibs0)."  ; echo "gen_calibrator('$@','$*')."; \
# 	  echo "halt." ) | $(PROLOGCMD) > $(LOGFILE)

GENCALIBCMD=( echo "consult(config)."   ; echo "consult(calibcommon)."; \
	      echo "consult(c_common)." ; echo "consult('$<')."; \
	      echo "consult(calibs0)."  ; echo "gen_calibrator('$@','$(@:_c.pl=)')."; \
	      echo "halt." ) | $(PROLOGCMD) > $(LOGFILE)

%_$(CALIB2_NPROF)_prof_c.pl: %.pl $(COMMONPL)
	$(GENCALIBCMD)

%_$(CALIB2_NTIME)_time_c.pl: %.pl $(COMMONPL)
	$(GENCALIBCMD)

%_0_prof_c.pl: %.pl $(COMMONPL)
	$(GENCALIBCMD)

 %_0_time_c.pl: %.pl $(COMMONPL)
	$(GENCALIBCMD)

%.pin: %.tmpl
	sed -e s:"<MeasureInit>":"profile('$*',":g -e s:"<MeasureEnd>":")":g \
	  $< > $@

%.oin: %.tmpl # observed input
	sed -e s:"<MeasureInit>":"best_measure($(CALIB2_NREPS),'$*.oti',":g -e s:"<MeasureEnd>":")":g \
	  $< > $@
