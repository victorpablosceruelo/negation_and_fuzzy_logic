:- module(laplace, [go1/0,go2/1], []).

%
% Solve the Dirichlet problem for Laplace's equation using
% Leibman's five-point finit-differenc approximation. 
% The goal ?- go1 is a normal example, while the goal ?- go2
% shows output constraints for a small region where the boundary conditions
% are not specified.
%
:- use_package(clpq).
:- use_module(library(format)).

laplace([_, _]).
laplace([H1, H2, H3|T]):-
	laplace_vec(H1, H2, H3), 
	laplace([H2, H3|T]).

laplace_vec([_, _], [_, _], [_, _]).
laplace_vec([_TL, T, TR|T1], [ML, M, MR|T2], [_BL, B, BR|T3]):-
	B + T + ML + MR - 4 * M .=. 0, 
	laplace_vec([T, TR|T1], [M, MR|T2], [B, BR|T3]).

printmat([]).
printmat([H|T]):-
	printvec(H), 
	printmat(T).

printvec([]):- nl.
printvec([H|T]):-
	printrat(H), 
	printvec(T).

printrat(rat(N,D)) :- !,
        X is N/D,
        format(" ~f",X).
printrat(N) :-
        X is N*100,
        format(" ~d",X).

go1:-
	X =  [
      [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
    [100, _, _, _, _, _, _, _, _, _, 100], 
    [100, _, _, _, _, _, _, _, _, _, 100], 
    [100, _, _, _, _, _, _, _, _, _, 100], 
    [100, _, _, _, _, _, _, _, _, _, 100], 
    [100, _, _, _, _, _, _, _, _, _, 100], 
    [100, _, _, _, _, _, _, _, _, _, 100], 
    [100, _, _, _, _, _, _, _, _, _, 100], 
    [100, _, _, _, _, _, _, _, _, _, 100], 
    [100, _, _, _, _, _, _, _, _, _, 100], 
    [100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100]
    ], 
	laplace(X),
        answer(Y),
        (
            X = Y ->
            format("Seems to be correct~n", [])
        ;
            format("Uh, oh! Answer differs with the precomputed one~n", [])
        ).


answer(X):- X =
[[0,0,0,0,0,0,0,0,0,0,0],[100,rat(7260609900,142065451),rat(30712773729475,944399458084),rat(63795004229775,2597098509731),rat(4983083333400,236099864521),rat(52248395437475,2597098509731),rat(4983083333400,236099864521),rat(63795004229775,2597098509731),rat(30712773729475,944399458084),rat(7260609900,142065451),100],[100,rat(747019438393775,10388394038924),rat(702738050,12915041),rat(463623889982575,10388394038924),rat(51839410850,1304419141),rat(99365748415100,2597098509731),rat(51839410850,1304419141),rat(463623889982575,10388394038924),rat(702738050,12915041),rat(747019438393775,10388394038924),100],[100,rat(213264080626225,2597098509731),rat(64776810545475,944399458084),rat(8495285900,142065451),rat(51913974702275,944399458084),rat(138790064218225,2597098509731),rat(51913974702275,944399458084),rat(8495285900,142065451),rat(64776810545475,944399458084),rat(213264080626225,2597098509731),100],[100,rat(228455382933300,2597098509731),rat(101790164050,1304419141),rat(737614616898575,10388394038924),rat(864032050,12915041),rat(340535295190575,5194197019462),rat(864032050,12915041),rat(737614616898575,10388394038924),rat(101790164050,1304419141),rat(228455382933300,2597098509731),100],[100,rat(1676575,18281),rat(1546200,18281),rat(1449325,18281),rat(2781275,36562),75,rat(2781275,36562),rat(1449325,18281),rat(1546200,18281),rat(1676575,18281),100],[100,rat(244906699798700,2597098509731),rat(116474028850,1304419141),rat(887876963625775,10388394038924),rat(1073224100,12915041),rat(427477636187975,5194197019462),rat(1073224100,12915041),rat(887876963625775,10388394038924),rat(116474028850,1304419141),rat(244906699798700,2597098509731),100],[100,rat(249833773271025,2597098509731),rat(87658772625475,944399458084),rat(12814531750,142065451),rat(83633900857075,944399458084),rat(228541469159925,2597098509731),rat(83633900857075,944399458084),rat(12814531750,142065451),rat(87658772625475,944399458084),rat(249833773271025,2597098509731),100],[100,rat(1014627670368975,10388394038924),rat(1234518100,12915041),rat(976102906814175,10388394038924),rat(121222138550,1304419141),rat(240440603831800,2597098509731),rat(121222138550,1304419141),rat(976102906814175,10388394038924),rat(1234518100,12915041),rat(1014627670368975,10388394038924),100],[100,rat(14049207750,142065451),rat(92457326535475,944399458084),rat(252236694792275,2597098509731),rat(22813959410900,236099864521),rat(250514390461175,2597098509731),rat(22813959410900,236099864521),rat(252236694792275,2597098509731),rat(92457326535475,944399458084),rat(14049207750,142065451),100],[100,100,100,100,100,100,100,100,100,100,100]].


% Answer:
% 0,.00 0,.00 0,.00 0,.00], 0.00 0.00 0.00 0.00 0.00 0.00 0.00
% 100.00 51.11 32.52 24.56 21.11 20.12 21.11 24.56 32.52 51.11 100.00
% 100.00 71.91 54.41 44.63 39.74 38.26 39.74 44.63 54.41 71.91 100.00
% 100.00 82.12 68.59 59.80 54.97 53.44 54.97 59.80 68.59 82.12 100.00
% 100.00 87.97 78.03 71.00 66.90 65.56 66.90 71.00 78.03 87.97 100.00
% 100.00 91.71 84.58 79.28 76.07 75.00 76.07 79.28 84.58 91.71 100.00
% 100.00 94.30 89.29 85.47 83.10 82.30 83.10 85.47 89.29 94.30 100.00
% 100.00 96.20 92.82 90.20 88.56 88.00 88.56 90.20 92.82 96.20 100.00
% 100.00 97.67 95.59 93.96 92.93 92.58 92.93 93.96 95.59 97.67 100.00
% 100.00 98.89 97.90 97.12 96.63 96.46 96.63 97.12 97.90 98.89 100.00
% 100.00 100.00 100.00 100.00 100.00 100.00 100.00 100.00 100.00 100.00 100.00

go2([B31, M32, M33, B34, B42, B43, B12, B13, B21, M22, M23, B24]) :-
	laplace([
    	[_B11, B12, B13, _B14], 
    	[B21, M22, M23, B24], 
    	[B31, M32, M33, B34], 
    	[_B41, B42, B43, _B44]
    ]).
    	  

% Answer:
% 
% B34.=. -4*M22+B12+B21+4*M33-B43,
% M23.=.4*M22-M32-B12-B21,
% B31.=. -M22+4*M32-M33-B42,
% B24.=.15*M22-4*M32-4*B12-4*B21-M33-B13 ? 
