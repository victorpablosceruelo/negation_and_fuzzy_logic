:- module( rtchecks_tr , [ transform_as_saved/3 , transform_check/3 ] , []  ).


:- use_module(library(compiler(c_itf)), [location/3]).

transform_as_saved( '$saved_assertion'( Num , AS ) , 
	            '$saved_assertion'( Module , Num , AS ) , 
		    Module ).




transform_check( rtchecks_mod:clean_parent_stack ,
	         rtchecks_mod:clean_parent_stack( M ) ,
		 M ).

transform_check( clean_parent_stack ,
	         clean_parent_stack( M ) ,
		 M ).




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% CHECK
%%
%% There are two neccessary transformations:
%%
%% 1.- normal checkpoint: check( Condition ). It has to be transformed to
%%     have aditional data about Module and Location. The transformed 
%%     version will be: check( Condition , Location , Module ).
%%
%% 2.- chekpoint with errorinfo: check( Condition, AssertionNumber ).
%%     This checkpoints are generated by CiaoPP Run-time checking
%%     transformations. Location and Module are also added. The output
%%     should be: check( Condition , (Assertion,Location) , Module ).
%%
%% The other two transformations are exactly the same but considering the 
%% possibly of having 'rtcheck_mod' module qualifier.
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Moved to rtchecks_mod
% transform_check( check( CC , AS ) , icheck( CC , AS , M ) , M ).

% This happends when the program has never been transformed by CiaoPP
transform_check( check( CC ) , check( CC , L ) , _ ) :-
	get_location( L ).

% transform_check( check(  CC , L ), icheck( CC , L ), _ ).


% --- Should be done in the transformation. But what happends if the
% user did not use CiaoPP first?
transform_check( rtchecks_mod:check(  CC ),
	         rtchecks_mod:icheck( CC , L ), _ ) :-
	get_location( L ).

% transform_check( rtchecks_mod:check(  CC , L ),
% 	         rtchecks_mod:icheck( CC , L ), _ ).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% CHECK IF TRUE
%%
%% The same kind of transformation as done in check predicate are requieres 
%% here.
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% This happends when the program has never been transformed by CiaoPP
transform_check( checkiftrue( Cond , AS ) , 
	         checkiftrue( Cond , AS , L ) , _ ) :-
	get_location( L ).

transform_check( rtchecks_mod:checkiftrue( Cond , AS ) , 
	         rtchecks_mod:checkiftrue( Cond , AS , L ) , _ ) :-
	get_location( L ).



get_location( loc( L1 , L2 , L3 ) ) :-
	location( L1 , L2 , L3 ).
